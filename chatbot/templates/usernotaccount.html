{% extends 'base.html'%} {% block content %}

<div class="d-flex user">
  <div class="notaccount">
    <h4>Câu hỏi thường gặp</h4>
    <ul class="notaccount-list">
      <li>Có thể chat ngay bây giờ không?</li>
      <li>Tiêu chí tuyển sinh trong năm nay?</li>
      <li>Điều kiện nhập học của trường là gì?</li>
      <li>Những quy định của trường phenikaa là gì?</li>
    </ul>
    <a href="{{url_for('login')}}" class="btn home-btn-text">Đăng Nhập</a>
  </div>
  <div class="user-chatPDF">
    <div class="user-chatPDF-conversation scroll" id="scrollable-content">
      {% for conversation in conversations %}
      <div class="user-chat">
        <div class="chat-item">
          <p class="chat-item-message">
            {{ conversation.user_chat }}
          </p>
        </div>
        <div class="chat-tk">
          <span class="username">
            <i class="fa-solid fa-user"></i>
          </span>
        </div>
      </div>
        
      <div class="chat-chat">
        <div class="chat-AI">
          <span>
            <img src="{{url_for('static', filename='images/artificial-intelligence.png')}}"/>
          </span>
        </div>
        <div class="chat-item">
          <p class="chat-item-messageAI">
            {{ conversation.bot_chat }}
          </p>
        </div>
      </div>

      {% endfor %}
    </div>
    <div class="background-image">
    </div>
    <!-- <div class="chatPDF-message">
      <textarea id="messageInput" rows="1" placeholder="Send a message" class=""></textarea>
      <button class="chatPDF-message-btn" id="sendMessageButton">
        <i class="fas fa-play"></i>
      </button>
    </div> -->
    <form class="chatPDF-message" id="input-form" method="POST" class="d-flex">
      <input placeholder="Send a message" type="text" id="messageInput" name="input_text" maxlength="500" class="d-flex">
      <button class="chatPDF-message-btn" id="sendMessageButton">
        <i class="fas fa-play"></i>
      </button>
    </form>
  </div>
</div>

<script>
  var listItems = document.querySelectorAll('.notaccount-list li');
  var textarea = document.getElementById('messageInput');
  listItems.forEach(function (item) {
    item.addEventListener('click', function () {
      var itemText = item.textContent;
      textarea.value = itemText;
    });
  });
</script>
<script>
  // scroll
  const scrollableContent = document.getElementById("scrollable-content");
  function scrollBottom() {
    scrollableContent.scrollTop = scrollableContent.scrollHeight;
  }
// Gửi tin nhắn
const conversationContainer = document.querySelector('.user-chatPDF-conversation');
var searchForm = document.getElementById('input-form');
searchForm.addEventListener('submit', async function(event) {
  event.preventDefault();
  const user_chat = messageInput.value;
  
  // Tạo div chứa câu hỏi của người dùng
  const userChatDiv = document.createElement('div');
  userChatDiv.className = 'user-chat';
  userChatDiv.innerHTML = `
    <div class="chat-item">
      <p class="chat-item-message">
        ${user_chat}
      </p>
    </div>
    <div class="chat-tk">
      <span class="username">
        <i class="fa-solid fa-user"></i>
      </span>
    </div>
  `;
  conversationContainer.appendChild(userChatDiv);

  // Tạo div chứa câu trả lời của bot
  const chatChatDiv = document.createElement('div');
  chatChatDiv.className = 'chat-chat';
  conversationContainer.appendChild(chatChatDiv);
  chatChatDiv.innerHTML = `
    <div class="chat-AI">
      <span>
        <img src="{{url_for('static', filename='images/artificial-intelligence.png')}}"/>
      </span>
    </div>
    <div class="chat-item">
      <p class="chat-item-messageAI">
        <i class="fa-solid fa-spinner fa-spin"></i>
      </p>
    </div>
  `;

  var formData = new FormData(searchForm);
  formData.append('input_text', searchForm.elements.input_text.value);
  try {
    const response = await fetch('/completion', {
      method: 'POST',
      body: formData
    });
    const reader = response.body.getReader();
    while (true) {
      const {done, value} = await reader.read(); 
      if (done) break; 
      const text = new TextDecoder().decode(value); 
      
      // Tìm câu trả lời của bot và thêm nội dung
      const chatItemMessageAI = chatChatDiv.querySelector('.chat-item-messageAI');
      chatItemMessageAI.innerHTML += text; 

      // Loại bỏ class icon
      // const iconSpinner = chatItemMessageAI.querySelector('i.fa-spinner');
      // if (iconSpinner) {
      //   iconSpinner.classList.remove('fa-spin');
      // }

      scrollBottom();
    }
  } catch (error) {
    console.error(error);
  }
});

</script>
{% endblock %}