{% extends 'base.html'%} {% block content %}

<div class="d-flex user">
  <div class="notaccount">
    <h4>Câu hỏi thường gặp</h4>
    <ul class="notaccount-list">
      <li>Hãy giải thích cho tôi về bản chất của tài chính doanh nghiệp</li>
      <li>Mục đích sử dụng của cải tài sản cố định?</li>
      <li>Tại sao tài chính được xem là một công cụ quan trọng trong quản trị doanh nghiệp?</li>
      <li>Tại sao việc tái cấu trúc công ty lại là một phần quan trọng của chiến lược thay đổi của doanh nghiệp?</li>
    </ul>
    <a href="{{url_for('login')}}" class="btn home-btn-text">Đăng Nhập</a>
  </div>
  <div class="user-chatPDF">
    <div class="user-chatPDF-conversation scroll" id="scrollable-content">
      {% for conversation in conversations %}
      <div class="user-chat">
        <div class="chat-item">
          <p class="chat-item-message">
            {{ conversation.user_chat }}
          </p>
        </div>
        <div class="chat-tk">
          <span class="username">
            <i class="fa-solid fa-user"></i>
          </span>
        </div>
      </div>
        
      <div class="chat-chat">
        <div class="chat-AI">
          <span>
            <img src="{{url_for('static', filename='images/artificial-intelligence.png')}}"/>
          </span>
        </div>
        <div class="chat-item">
          <p class="chat-item-messageAI">
            {{ conversation.bot_chat }}
          </p>
        </div>
      </div>

      {% endfor %}
    </div>
    <div class="background-image">
    </div>
    <div class="d-flex chatPDF-message-usernotaccount">
      <div class="optionAI">
        <ul class="optionAI-list">
          <li class="optionAI-item">
            GPT4All
          </li>
          <li class="optionAI-item" style="border-top: 1px solid #ccc">
            Llama2
          </li>
        </ul> 
        <span class="optionAI-box">
          <span>Model</span>
          <div class="optionAI-hover">
            GPT4All
          </div>
        </span>
      </div>
      <form class="chatPDF-message-form" id="input-form" method="POST" class="d-flex">
        <textarea type="text" id="messageInput" name="input_text" rows="1" placeholder="Send a message" class="d-flex"></textarea>
        <button class="chatPDF-message-btn" id="sendMessageButton">
          <i class="fas fa-play"></i>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // scroll
  const scrollableContent = document.getElementById("scrollable-content");
  function scrollBottom() {
    scrollableContent.scrollTop = scrollableContent.scrollHeight;
  }
  // Gửi tin nhắn
const conversationContainer = document.querySelector('.user-chatPDF-conversation');
var searchForm = document.getElementById('input-form');
searchForm.addEventListener('submit', async function(event) {
  event.preventDefault();
  var formData = new FormData(searchForm);
  formData.append('input_text', searchForm.elements.input_text.value);
  if (selectedModel !== '') {
    formData.append('model', selectedModel); // Thêm tên model vào FormData
  }
  
  const user_chat = messageInput.value;
  let receivedResponse = false;
  messageInput.value = '';
  // Tạo div chứa câu hỏi của người dùng
  const userChatDiv = document.createElement('div');
  userChatDiv.className = 'user-chat';
  userChatDiv.innerHTML = `
    <div class="chat-item">
      <p class="chat-item-message">
        ${user_chat}
      </p>
    </div>
    <div class="chat-tk" id="scrollable-content">
      <span class="username">
        <i class="fa-solid fa-user"></i>
      </span>
    </div>
  `;
  conversationContainer.appendChild(userChatDiv);

  // Tạo div chứa câu trả lời của bot
  const chatChatDiv = document.createElement('div');
  chatChatDiv.className = 'chat-chat';
  conversationContainer.appendChild(chatChatDiv);
  chatChatDiv.innerHTML = `
    <div class="chat-AI">
      <span>
        <img src="{{url_for('static', filename='images/artificial-intelligence.png')}}"/>
      </span>
    </div>
    <div class="chat-item">
      <p class="chat-item-messageAI">
        <i class="fa-solid fa-spinner fa-spin icon-spinner"></i>
      </p>
    </div>
  `;

  
  try {
    const response = await fetch('/add_conversation', {
      method: 'POST',
      body: formData
    });
    const reader = response.body.getReader();
    while (true) {
      const {done, value} = await reader.read(); 
      if (done) break;  
      const text = new TextDecoder().decode(value); 
      
      // Tìm câu trả lời của bot và thêm nội dung
      const chatItemMessageAI = chatChatDiv.querySelector('.chat-item-messageAI');
      chatItemMessageAI.innerHTML += text; 

      // Kiểm tra nếu chưa nhận được câu trả lời từ server
      if (!receivedResponse) {
    receivedResponse = true; // Đặt biến receivedResponse thành true
    console.log(receivedResponse);
    // Loại bỏ biểu tượng loading nếu có giá trị text
    if (text.trim() !== '') {
        const iconSpinner = chatChatDiv.querySelector('.icon-spinner');
        if (iconSpinner) {
            iconSpinner.parentNode.removeChild(iconSpinner);
        }
    }
}

scrollBottom();
    }
  } catch (error) {
    console.error(error);
  }
});

</script>
<script>
  let selectedModel = 'GPT4All';
  const optionAI = document.querySelector(".optionAI-box");
  const optionAIList = document.querySelector(".optionAI-list");
  const optionAIHover = document.querySelector(".optionAI-hover");
  
  // Lắng nghe sự kiện click vào một mục trong danh sách
  optionAIList.addEventListener('click', function(event) {
    // Kiểm tra xem phần tử được click là một mục trong danh sách
    if (event.target.classList.contains('optionAI-item')) {
      selectedModel = event.target.textContent.trim(); 
      // Lấy nội dung của mục được click
      const modelName = event.target.textContent.trim();
      // Thay đổi nội dung của optionAI-hover thành tên model được chọn
      optionAIHover.textContent = modelName;
    }
  });

  optionAI.addEventListener('click', function(){
    optionAIList.style.display = "block";
    optionAIHover.classList.toggle('show');
    setTimeout(function(){
    optionAIList.style.display = "none";
    optionAIHover.classList.remove('show');
    }, 4000)
  });
</script>

{% endblock %}